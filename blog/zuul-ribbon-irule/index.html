<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>zuul 自定义负载策略 | 逆天改命</title><meta name=google-adsense-account content="ca-pub-7732072032123305"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=keywords content><meta name=description content="定制IRule 使前后端开发可定制匹配, 学习并配置了网关的负载策略，zuul 底层使用的是 ribbon 的负载组件, ribbon 可以从 eureka 获取服务列表, 所以想要自定义负载, 得从 ribbon 入手, 查看并搜索 loadBalance 相关的类, 可以看到 AbstractLoadBalancerRule 这个类, 查看类树, 可以看到顶级接口为 IRule
/** * 决定最终的服务提供者 */ public Server choose(Object key); /** * 设置负载均衡器 */ public void setLoadBalancer(ILoadBalancer lb); /** * 拿到负载均衡器 */ public ILoadBalancer getLoadBalancer(); debug 分析, 得知 ribbon 默认的负载策略为: ZoneAvoidanceRule, 这个类继承自 AbstractLoadBalancerRule, AbstractLoadBalancerRule中存在 ILoadBalancer 属性, 可以获取负载器, 负载器中又可以获取服务列表等信息
所以我们只需要继承ZoneAvoidanceRule, 重写 choose 方法即可
ribbon 默认的负载器为: DynamicServerListLoadBalancer, 其中包括节点健康状态服务支持, 节点状态的更新(ServerListUpdater), 负载策略, 可用区域的分析, 可以从此类详细了解 ribbon 的运行机制"><meta name=generator content="Hugo 0.119.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><link rel=canonical href=https://linkall.pub/blog/zuul-ribbon-irule/><meta property="og:title" content="zuul 自定义负载策略"><meta property="og:description" content="定制IRule 使前后端开发可定制匹配, 学习并配置了网关的负载策略，zuul 底层使用的是 ribbon 的负载组件, ribbon 可以从 eureka 获取服务列表, 所以想要自定义负载, 得从 ribbon 入手, 查看并搜索 loadBalance 相关的类, 可以看到 AbstractLoadBalancerRule 这个类, 查看类树, 可以看到顶级接口为 IRule
/** * 决定最终的服务提供者 */ public Server choose(Object key); /** * 设置负载均衡器 */ public void setLoadBalancer(ILoadBalancer lb); /** * 拿到负载均衡器 */ public ILoadBalancer getLoadBalancer(); debug 分析, 得知 ribbon 默认的负载策略为: ZoneAvoidanceRule, 这个类继承自 AbstractLoadBalancerRule, AbstractLoadBalancerRule中存在 ILoadBalancer 属性, 可以获取负载器, 负载器中又可以获取服务列表等信息
所以我们只需要继承ZoneAvoidanceRule, 重写 choose 方法即可
ribbon 默认的负载器为: DynamicServerListLoadBalancer, 其中包括节点健康状态服务支持, 节点状态的更新(ServerListUpdater), 负载策略, 可用区域的分析, 可以从此类详细了解 ribbon 的运行机制"><meta property="og:type" content="article"><meta property="og:url" content="https://linkall.pub/blog/zuul-ribbon-irule/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-07-27T22:21:48+00:00"><meta property="article:modified_time" content="2020-07-27T22:21:48+00:00"><meta itemprop=name content="zuul 自定义负载策略"><meta itemprop=description content="定制IRule 使前后端开发可定制匹配, 学习并配置了网关的负载策略，zuul 底层使用的是 ribbon 的负载组件, ribbon 可以从 eureka 获取服务列表, 所以想要自定义负载, 得从 ribbon 入手, 查看并搜索 loadBalance 相关的类, 可以看到 AbstractLoadBalancerRule 这个类, 查看类树, 可以看到顶级接口为 IRule
/** * 决定最终的服务提供者 */ public Server choose(Object key); /** * 设置负载均衡器 */ public void setLoadBalancer(ILoadBalancer lb); /** * 拿到负载均衡器 */ public ILoadBalancer getLoadBalancer(); debug 分析, 得知 ribbon 默认的负载策略为: ZoneAvoidanceRule, 这个类继承自 AbstractLoadBalancerRule, AbstractLoadBalancerRule中存在 ILoadBalancer 属性, 可以获取负载器, 负载器中又可以获取服务列表等信息
所以我们只需要继承ZoneAvoidanceRule, 重写 choose 方法即可
ribbon 默认的负载器为: DynamicServerListLoadBalancer, 其中包括节点健康状态服务支持, 节点状态的更新(ServerListUpdater), 负载策略, 可用区域的分析, 可以从此类详细了解 ribbon 的运行机制"><meta itemprop=datePublished content="2020-07-27T22:21:48+00:00"><meta itemprop=dateModified content="2020-07-27T22:21:48+00:00"><meta itemprop=wordCount content="248"><meta itemprop=keywords content="springboot,java,debug,"><meta name=twitter:card content="summary"><meta name=twitter:title content="zuul 自定义负载策略"><meta name=twitter:description content="定制IRule 使前后端开发可定制匹配, 学习并配置了网关的负载策略，zuul 底层使用的是 ribbon 的负载组件, ribbon 可以从 eureka 获取服务列表, 所以想要自定义负载, 得从 ribbon 入手, 查看并搜索 loadBalance 相关的类, 可以看到 AbstractLoadBalancerRule 这个类, 查看类树, 可以看到顶级接口为 IRule
/** * 决定最终的服务提供者 */ public Server choose(Object key); /** * 设置负载均衡器 */ public void setLoadBalancer(ILoadBalancer lb); /** * 拿到负载均衡器 */ public ILoadBalancer getLoadBalancer(); debug 分析, 得知 ribbon 默认的负载策略为: ZoneAvoidanceRule, 这个类继承自 AbstractLoadBalancerRule, AbstractLoadBalancerRule中存在 ILoadBalancer 属性, 可以获取负载器, 负载器中又可以获取服务列表等信息
所以我们只需要继承ZoneAvoidanceRule, 重写 choose 方法即可
ribbon 默认的负载器为: DynamicServerListLoadBalancer, 其中包括节点健康状态服务支持, 节点状态的更新(ServerListUpdater), 负载策略, 可用区域的分析, 可以从此类详细了解 ribbon 的运行机制"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">逆天改命</a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Blogs</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">zuul 自定义负载策略</h1><time class="f6 mv4 dib tracked" datetime=2020-07-27T22:21:48Z>July 27, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=定制irule>定制IRule</h2><p>使前后端开发可定制匹配, 学习并配置了网关的负载策略，zuul 底层使用的是 ribbon 的负载组件, ribbon 可以从 eureka 获取服务列表, 所以想要自定义负载, 得从 ribbon 入手, 查看并搜索 loadBalance 相关的类, 可以看到 AbstractLoadBalancerRule 这个类, 查看类树, 可以看到顶级接口为 IRule</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>* 决定最终的服务提供者
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Server <span style=color:#a6e22e>choose</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>* 设置负载均衡器
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLoadBalancer</span><span style=color:#f92672>(</span>ILoadBalancer lb<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>* 拿到负载均衡器
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ILoadBalancer <span style=color:#a6e22e>getLoadBalancer</span><span style=color:#f92672>();</span>    
</span></span></code></pre></div><p>debug 分析, 得知 ribbon 默认的负载策略为: ZoneAvoidanceRule, 这个类继承自 AbstractLoadBalancerRule, AbstractLoadBalancerRule中存在 ILoadBalancer 属性, 可以获取负载器, 负载器中又可以获取服务列表等信息</p><p>所以我们只需要继承ZoneAvoidanceRule, 重写 choose 方法即可</p><p>ribbon 默认的负载器为: DynamicServerListLoadBalancer, 其中包括节点健康状态服务支持, 节点状态的更新(ServerListUpdater), 负载策略, 可用区域的分析, 可以从此类详细了解 ribbon 的运行机制</p><h2 id=解决>解决</h2><p>自定义路由策略, 继承ZoneAvoidanceRule, 当有特定标记的请求过来时, 走定义的服务, 如果没有, 则还是走默认的路由策略，自定义路由策略, 继承ZoneAvoidanceRule, 当有特定标记的请求过来时, 走定义的服务, 如果没有, 则还是走默认的路由策略。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.gomyck.util.ResponseWriter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.gomyck.util.StringJudge<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.gomyck.util.TokenTake<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.netflix.loadbalancer.ILoadBalancer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.netflix.loadbalancer.Server<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.netflix.loadbalancer.ZoneAvoidanceRule<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author gomyck
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @version 1.0.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @contact qq: 474798383
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @blog https://blog.gomyck.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @since 2020-03-16
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CkLoadBalanceRule</span> <span style=color:#66d9ef>extends</span> ZoneAvoidanceRule <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Logger log <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>CkLoadBalanceRule<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Server <span style=color:#a6e22e>choose</span><span style=color:#f92672>(</span>Object key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ILoadBalancer loadBalancer <span style=color:#f92672>=</span> getLoadBalancer<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>Server<span style=color:#f92672>&gt;</span> allServers <span style=color:#f92672>=</span> loadBalancer<span style=color:#f92672>.</span><span style=color:#a6e22e>getReachableServers</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        String ckDev <span style=color:#f92672>=</span> TokenTake<span style=color:#f92672>.</span><span style=color:#a6e22e>getToken</span><span style=color:#f92672>(</span>ResponseWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequest</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;CkDev&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span><span style=color:#75715e>//todo 兼容了同一个前端项目  存在请求多个服务的情况, 只对比名字, 忽略项目名称, 在此拿到的服务列表为已匹配的路由表, 不需要根据服务名二次匹配
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringJudge<span style=color:#f92672>.</span><span style=color:#a6e22e>notNull</span><span style=color:#f92672>(</span>ckDev<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CkLoadBalanceRule will route server name is: &#34;</span> <span style=color:#f92672>+</span> ckDev<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String _ckDev <span style=color:#f92672>=</span> ckDev<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>)[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                Server server <span style=color:#f92672>=</span> allServers<span style=color:#f92672>.</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>().</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>e <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    String instanceId <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMetaInfo</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getInstanceId</span><span style=color:#f92672>().</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>)[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> _ckDev<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>instanceId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}).</span><span style=color:#a6e22e>findFirst</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>server<span style=color:#f92672>.</span><span style=color:#a6e22e>isAlive</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>server<span style=color:#f92672>.</span><span style=color:#a6e22e>isReadyToServe</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>server<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;server :&#34;</span> <span style=color:#f92672>+</span> server<span style=color:#f92672>.</span><span style=color:#a6e22e>getMetaInfo</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAppName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; is not available!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>choose</span><span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>在 zuul 服务的 yml 文件中配置需要使用该负载策略的服务 ID, 格式为:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>server-name</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ribbon</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NFLoadBalancerRuleClassName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>com.gomyck.gateway.config.CkLoadBalanceRule</span>
</span></span></code></pre></div><h4 id=疑惑解答>疑惑解答</h4><p>在最开始, 我把自定义负载策略注册成 bean, 发现所有的路由都失效了, debug 发现, 策略 bean 拿到的服务, 缺失, 注释掉 bean, 查看之前的运行逻辑, 发现每个服务都对应一个路由策略实例, 也就是每个服务对应各自的 IRule 实例</p><ul class=pa0><li class="list di"><a href=/tags/springboot/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">springboot</a></li><li class="list di"><a href=/tags/java/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a></li><li class="list di"><a href=/tags/debug/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">debug</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/too-many-open-files/>java:too many open files 解决办法</a></li><li class=mb2><a href=/blog/teamview-uninstall/>无法开机 ,报 不可恢复的错误：securityagent无法创建所要求的机制teamviewerauthplugin:start</a></li><li class=mb2><a href=/blog/mybatis-auto-id/>MyBatis获取插入记录的自增长字段值</a></li><li class=mb2><a href=/blog/springboot-profile-config/>Springboot 指定profile配置文件</a></li><li class=mb2><a href=/blog/zuul-upload-config/>zuul 网关上传文件大小配置</a></li><li class=mb2><a href=/blog/troubleshooting-of-high-cpu-consumption-of-online-java-programs/>线上java程序CPU占用过高问题排查</a></li></ul></div></aside><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7732072032123305" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7732072032123305 data-ad-slot=6735921740 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://linkall.pub/>&copy; 逆天改命 2024</a><div><div class=ananke-socials></div></div></div></footer></body></html>